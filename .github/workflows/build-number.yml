on:
  workflow_call:
    inputs:
      sub_folder:
        description: "The sub folder"
        required: false
        default: ""
        type: string
    outputs:
      builder_number:
        description: "The builder number"
        value: ${{ jobs.main.outputs.builder_number }}

jobs:
  main:
    runs-on: ubuntu-latest
    outputs:
      builder_number: ${{ steps.existing-build-number.outputs.builder_number && steps.next-build-number.outputs.builder_number }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-tags: true
          
      - name: Fetch tags
        run: |
          git fetch --tags
          git show-ref --tags

      - name: Get current version for the commit
        id: current-build-number
        run: |
          CURRENT_NUMBER=$(git tag -l --points-at ${{ github.sha }} | grep -E '^build/${{ inputs.sub_folder }}[0-9]+$') || HIDE_EXIT_CODE=$?
          if [ ! -z "$CURRENT_NUMBER" ]; then
            SUB_FOLDER=$(echo ${{ inputs.sub_folder }} | sed -E 's/(\/)/\\\//')
            CURRENT_NUMBER=$(echo $CURRENT_NUMBER | sed -e "s/^build\/${SUB_FOLDER}//")      
            echo "CURRENT_BUILD_NUMBER=$CURRENT_NUMBER" >> $GITHUB_OUTPUT
          fi

      - name: Set builder number
        id: existing-build-number
        if: ${{ steps.current-build-number.outputs.CURRENT_BUILD_NUMBER != '' }}
        run: echo "builder_number=${{ steps.current-build-number.outputs.CURRENT_BUILD_NUMBER }}" >> $GITHUB_OUTPUT

      - name: Generate builder number
        id: next-build-number
        if: ${{ steps.current-build-number.outputs.CURRENT_BUILD_NUMBER == '' }}
        run: |
          LAST_BUILD_NUMBER=$(git tag -l | grep -E '^build/${{ inputs.sub_folder }}[0-9]+$' | sort -u | tail -1) || HIDE_EXIT_CODE=$?
          if [ -z "$LAST_BUILD_NUMBER" ]; then
            LAST_BUILD_NUMBER="0"
          else
            SUB_FOLDER=$(echo ${{ inputs.sub_folder }} | sed -E 's/(\/)/\\\//')
            LAST_BUILD_NUMBER=$(echo $LAST_BUILD_NUMBER | sed -e "s/^build\/${SUB_FOLDER}//")
          fi
          LAST_BUILD_NUMBER=$((LAST_BUILD_NUMBER + 1))
          EXIT_CODE=0
          git tag "build/${{ inputs.sub_folder }}${LAST_BUILD_NUMBER}" ${{ github.sha }} && git push --tags || EXIT_CODE=$?
          if [ $EXIT_CODE -ne 0 ]; then
            git fetch --tags
            CURRENT_NUMBER=$(git tag -l --points-at ${{ github.sha }} | grep -E '^build/${{ inputs.sub_folder }}[0-9]+$') || HIDE_EXIT_CODE=$?
            if [ ! -z "$CURRENT_NUMBER" ]; then
              SUB_FOLDER=$(echo ${{ inputs.sub_folder }} | sed -E 's/(\/)/\\\//')
              LAST_BUILD_NUMBER=$(echo $CURRENT_NUMBER |  sed -e "s/^build\/${SUB_FOLDER}//")
            fi
          fi
          echo "builder_number=$LAST_BUILD_NUMBER" >> $GITHUB_OUTPUT
          
      - name: Dump outputs
        if: always()
        run: echo "$GITHUB_OUTPUT"
