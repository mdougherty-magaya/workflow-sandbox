on:
  workflow_call:
    inputs: 
      sub_folder:
        description: "The sub folder"
        required: false
        default: ""
        type: string
    outputs:
      builder_number: 
        description: "The builder number"
        value: ${{ jobs.main.outputs.builder_number }}
    
jobs:
  main:
    runs-on: ubuntu-latest    
    outputs:
      builder_number: ${{ steps.define-existing-build-number.outputs.builder_number || steps.define-next-build-number.outputs.builder_number }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-tags: true
          
      - name: List working files
        run: |
          echo ${PWD}
          ls -lash 
          
      - name: Git commands
        run: |
          git --version
          git fetch --tags
          git log --format=oneline
          git show-ref --tags
          git tag -l
          git tag -l --points-at ${{ github.sha }}
          SHA_TAG=$(git tag -l --points-at ${{ github.sha }})
          git tag -l --points-at b9cb031909a15fa697d68b5d671e6ec15fa01d34
          git tag -l --points-at 5048a0f245a03bfa49631ebe38ded00fef86e9bc
          LAST_VERSION=$(git tag -l | sort -u | tail -1)
          echo "SHA_TAG=$SHA_TAG"          
          echo "LAST_VERSION=$LAST_VERSION"
          
      - name: Get current version for the commit   
        id: current-build-number
        run: |
          CURRENT_NUMBER=$(git tag -l --points-at ${{ github.sha }} | grep -E '^build/${{ inputs.sub_folder }}[0-9]+$') || HIDE_EXIT_CODE=$?
          if [ ! -z "$CURRENT_NUMBER" ]; then
            echo "CURRENT_BUILD_NUMBER=$CURRENT_NUMBER" >> $GITHUB_OUTPUT
          fi

      - name: Set builder number
        id: define-existing-build-number
        if: ${{ steps.current-build-number.outputs.CURRENT_BUILD_NUMBER != '' }}
        run: echo "builder_number=${{ steps.current-build-number.outputs.CURRENT_BUILD_NUMBER }}" >> $GITHUB_OUTPUT
        
      - name: Generate builder number
        id: define-next-build-number
        if: ${{ steps.current-build-number.outputs.CURRENT_BUILD_NUMBER == '' }}
        run: |
          LAST_VERSION=$(git tag -l | grep -E '^build/${{ inputs.sub_folder }}[0-9]+$' | sort -u | tail -1) || HIDE_EXIT_CODE=$?
          if [ -z "$LAST_VERSION" ]; then
            LAST_VERSION="0"
          else
            LAST_VERSION=$(echo $LAST_VERSION | sed -e "s/^build\/${{ inputs.sub_folder }}//")
          fi
          LAST_VERSION=$((LAST_VERSION + 1))
          git tag "build/${{ inputs.sub_folder }}${LAST_VERSION}" ${{ github.sha }} && git push --tags
          echo "builder_number=$LAST_VERSION" >> $GITHUB_OUTPUT
